<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.busanbank.card.user.mapper.ChatMapper">

    <!-- 채팅방 생성 -->
    <insert id="insertChatRoom"
            parameterType="com.busanbank.card.user.dto.ChatRoomDto"
            useGeneratedKeys="true" keyProperty="roomId" keyColumn="ROOM_ID">
        INSERT INTO CHAT_ROOM
        (ROOM_ID, MEMBER_NO, UNREAD_COUNT, CREATED_AT)
        VALUES
        (SEQ_CHAT_ROOM.NEXTVAL, #{memberNo}, 0, SYSDATE)
    </insert>

    <!-- 현재 시퀀스 -->
    <select id="selectCurrRoomId" resultType="long">
        SELECT SEQ_CHAT_ROOM.CURRVAL FROM DUAL
    </select>

    <!-- 기존 오픈된 채팅방 -->
    <select id="selectRoomIdByMember" resultType="long">
        SELECT ROOM_ID
        FROM CHAT_ROOM
        WHERE MEMBER_NO = #{memberNo}
          AND CLOSED_AT IS NULL
    </select>

    <!-- 가장 최근 열려 있는 채팅방 -->
    <select id="selectLatestOpenRoomIdByMember" parameterType="long" resultType="long">
        SELECT ROOM_ID
        FROM (
            SELECT ROOM_ID
            FROM CHAT_ROOM
            WHERE MEMBER_NO = #{memberNo}
              AND CLOSED_AT IS NULL
            ORDER BY CREATED_AT DESC
        )
        WHERE ROWNUM = 1
    </select>

    <!-- 채팅방 정보 조회 -->
    <select id="selectChatRoom"
            resultType="com.busanbank.card.user.dto.ChatRoomDto">
        SELECT
            ROOM_ID as roomId,
            MEMBER_NO as memberNo,
            ADMIN_NO as adminNo,
            UNREAD_COUNT as unreadCount,
            CREATED_AT as createdAt,
            CLOSED_AT as closedAt
        FROM CHAT_ROOM
        WHERE ROOM_ID = #{roomId}
    </select>

    <!-- 관리자 배정 -->
    <update id="assignAdminToRoom">
        UPDATE CHAT_ROOM
        SET ADMIN_NO = #{adminNo}
        WHERE ROOM_ID = #{roomId}
    </update>

    <!-- 채팅방 종료 -->
    <update id="closeRoom">
        UPDATE CHAT_ROOM
        SET CLOSED_AT = SYSDATE
        WHERE ROOM_ID = #{roomId}
    </update>

    <!-- 메시지 저장 (USER, ADMIN 공통) -->
    <insert id="insertChatMessage">
        INSERT INTO CHAT_MESSAGE
        (MSG_ID, ROOM_ID, SENDER_TYPE, SENDER_ID, MESSAGE, SENT_AT)
        VALUES
        (SEQ_CHAT_MESSAGE.NEXTVAL, #{roomId}, #{senderType}, #{senderId}, #{message}, SYSDATE)
    </insert>

    <!-- 메시지 전체 조회 -->
    <select id="selectMessages"
            resultType="com.busanbank.card.user.dto.ChatMessageDto">
        SELECT
            ROOM_ID as roomId,
            SENDER_TYPE as senderType,
            SENDER_ID as senderId,
            MESSAGE as message,
            SENT_AT as sentAt
        FROM CHAT_MESSAGE
        WHERE ROOM_ID = #{roomId}
        ORDER BY SENT_AT
    </select>

    <!-- 안읽은 수 증가 -->
    <update id="increaseUnreadCount">
        UPDATE CHAT_ROOM
        SET UNREAD_COUNT = UNREAD_COUNT + 1
        WHERE ROOM_ID = #{roomId}
    </update>

    <!-- 관리자용 전체 채팅방 조회 -->
    <select id="selectAllRooms" resultType="com.busanbank.card.user.dto.ChatRoomDto">
        SELECT
            ROOM_ID as roomId,
            MEMBER_NO as memberNo,
            ADMIN_NO as adminNo,
            UNREAD_COUNT as unreadCount,
            CREATED_AT as createdAt,
            CLOSED_AT as closedAt
        FROM CHAT_ROOM
        ORDER BY CREATED_AT DESC
    </select>

</mapper>
