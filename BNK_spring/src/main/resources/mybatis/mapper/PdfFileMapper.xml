<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busanbank.card.admin.dao.PdfFileMapper">

  <!-- ========== 업로드 ========== -->
  <insert id="insertPdfFile" parameterType="com.busanbank.card.admin.dto.PdfFile">
    <selectKey keyProperty="pdfNo" resultType="long" order="BEFORE">
      SELECT pdf_files_seq.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO pdf_files (
      pdf_no, pdf_name, pdf_data, is_active, term_scope, upload_date, admin_no
    ) VALUES (
      #{pdfNo}, #{pdfName}, #{pdfData}, #{isActive}, #{termScope}, SYSDATE, #{adminNo}
    )
  </insert>

  <!-- ========== 수정 ========== -->
  <update id="updatePdfWithFile" parameterType="com.busanbank.card.admin.dto.PdfFile">
    UPDATE pdf_files
       SET pdf_name   = #{pdfName}
         , is_active  = #{isActive}
         , term_scope = #{termScope}
         , upload_date= SYSDATE
         , admin_no   = #{adminNo}
         , pdf_data   = #{pdfData}
     WHERE pdf_no     = #{pdfNo}
  </update>

  <update id="updatePdfWithoutFile" parameterType="com.busanbank.card.admin.dto.PdfFile">
    UPDATE pdf_files
       SET pdf_name   = #{pdfName}
         , is_active  = #{isActive}
         , term_scope = #{termScope}
         , upload_date= SYSDATE
         , admin_no   = #{adminNo}
     WHERE pdf_no     = #{pdfNo}
  </update>

  <!-- ========== 삭제 ========== -->
  <delete id="deletePdf">
    DELETE FROM pdf_files
     WHERE pdf_no = #{pdfNo}
  </delete>

  <!-- ========== 목록 (BLOB 제외, 관리자 이름 통일: admin.name) ========== -->
  <select id="selectAllPdfFiles" resultType="com.busanbank.card.admin.dto.PdfFile">
    SELECT
      p.pdf_no      AS pdfNo,
      p.pdf_name    AS pdfName,
      /* p.pdf_data 제외 */
      p.is_active   AS isActive,
      p.term_scope  AS termScope,
      p.upload_date AS uploadDate,
      p.admin_no    AS adminNo,
      a.name        AS adminName
    FROM pdf_files p
    JOIN admin a ON a.admin_no = p.admin_no
    ORDER BY p.upload_date DESC
  </select>

  <!-- ========== (선택) 필터/페이징 목록 (BLOB 제외) ========== -->
  <!-- Oracle 기준: OFFSET/FETCH 사용 (12c+) -->
  <select id="selectPdfFilesFiltered" resultType="com.busanbank.card.admin.dto.PdfFile">
    SELECT
      p.pdf_no      AS pdfNo,
      p.pdf_name    AS pdfName,
      p.is_active   AS isActive,
      p.term_scope  AS termScope,
      p.upload_date AS uploadDate,
      p.admin_no    AS adminNo,
      a.name        AS adminName
    FROM pdf_files p
    JOIN admin a ON a.admin_no = p.admin_no
    <where>
      <if test="scope != null and scope != ''">
        AND p.term_scope = #{scope}
      </if>
      <if test="active != null and active != ''">
        AND p.is_active = #{active}
      </if>
    </where>
    ORDER BY p.upload_date DESC
    <if test="offset != null and limit != null">
      OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </if>
  </select>

  <!-- ========== 단건 (BLOB 포함: 다운로드/뷰어용) ========== -->
  <select id="selectPdfByNo" parameterType="long" resultType="com.busanbank.card.admin.dto.PdfFile">
    SELECT
      p.pdf_no      AS pdfNo,
      p.pdf_name    AS pdfName,
      p.pdf_data    AS pdfData,
      p.is_active   AS isActive,
      p.term_scope  AS termScope,
      p.upload_date AS uploadDate,
      p.admin_no    AS adminNo,
      a.name        AS adminName
    FROM pdf_files p
    JOIN admin a ON a.admin_no = p.admin_no
    WHERE p.pdf_no = #{pdfNo}
  </select>

</mapper>
