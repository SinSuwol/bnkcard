<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.busanbank.card.card.dao.CardApplicationMapper">

  <!-- ✅ Step 0: 카드 신청 마스터 등록 -->
  <insert id="insertCardApplication" parameterType="com.busanbank.card.card.dto.CardApplicationDTO">
  <selectKey keyProperty="applicationNo" resultType="java.lang.Long" order="BEFORE">
    SELECT CARD_APPLICATION_SEQ.NEXTVAL FROM DUAL
  </selectKey>
  INSERT INTO CARD_APPLICATION (
    APPLICATION_NO, MEMBER_NO, CARD_NO, SIGN_NO, STATUS, IS_CREDIT_CARD, CREATED_AT
  ) VALUES (
    #{applicationNo},
    #{memberNo},
    #{cardNo},
    #{signNo, jdbcType=NUMERIC}, <!-- ✅ 수정된 부분 -->
    #{status},
    #{isCreditCard},
    SYSDATE
  )
</insert>

  <!-- ✅ Step 1: 개인정보 입력 저장 -->
  <insert id="insertUserInfo" parameterType="com.busanbank.card.card.dto.ApplicationUserInfoDTO">
    <selectKey keyProperty="infoNo" resultType="java.lang.Long" order="BEFORE">
      SELECT APPLICATION_USER_INFO_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO APPLICATION_USER_INFO (
      INFO_NO, APPLICATION_NO, NAME, NAME_ENG,
      RRN_FRONT, RRN_TAIL_ENC, IS_EXISTING_ACCOUNT, CREATED_AT
    ) VALUES (
      #{infoNo}, #{applicationNo}, #{name}, #{nameEng},
      #{rrnFront}, #{rrnTailEnc}, #{isExistingAccount}, SYSDATE
    )
  </insert>

  <!-- ✅ Step 2: 약관 동의 저장 -->
  <insert id="insertAgreement" parameterType="com.busanbank.card.card.dto.ApplicationTermsDTO">
    <selectKey keyProperty="agreementNo" resultType="java.lang.Long" order="BEFORE">
      SELECT APPLICATION_TERMS_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO APPLICATION_TERMS (
      AGREEMENT_NO, APPLICATION_NO, TERM_NO, AGREED_AT
    ) VALUES (
      #{agreementNo}, #{applicationNo}, #{termNo}, SYSDATE
    )
  </insert>

  <!-- ✅ Step 3: 서명 이미지 저장 -->
  <insert id="insertSign" parameterType="com.busanbank.card.card.dto.ApplicationSignDTO">
    <selectKey keyProperty="signNo" resultType="java.lang.Long" order="BEFORE">
      SELECT APPLICATION_SIGN_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO APPLICATION_SIGN (
      SIGN_NO, APPLICATION_NO, AGREED_TEXT, SIGN_IMAGE, ID_IMAGE, SIGNED_AT
    ) VALUES (
      #{signNo}, #{applicationNo}, #{agreedText}, #{signImage}, #{idImage}, SYSDATE
    )
  </insert>

  <!-- ✅ 카드 번호로 필수 약관 목록 가져오기 -->
  <select id="getCardTermsByCardNo" parameterType="long"
          resultType="com.busanbank.card.card.dto.CardPdfMappingDTO">
    SELECT CARD_NO, PDF_NO, IS_REQUIRED
    FROM CARD_PDF_MAPPING
    WHERE CARD_NO = #{cardNo}
  </select>

  <!-- ✅ 신청번호로 전체 신청 상세정보 조회 -->
  <select id="getApplicationDetail" parameterType="long" resultType="map">
    SELECT
      ca.APPLICATION_NO,
      ca.MEMBER_NO,
      m.NAME AS MEMBER_NAME,
      m.USERNAME AS MEMBER_ID,
      c.CARD_NO,
      c.CARD_NAME,
      c.CARD_BRAND,
      c.CARD_TYPE,
      ca.STATUS,
      ca.IS_CREDIT_CARD,
      ca.CREATED_AT,
      au.NAME AS APPLICANT_NAME,
      au.NAME_ENG,
      au.RRN_FRONT,
      au.IS_EXISTING_ACCOUNT,
      asg.AGREED_TEXT,
      asg.SIGNED_AT
    FROM CARD_APPLICATION ca
    JOIN MEMBER m ON ca.MEMBER_NO = m.MEMBER_NO
    JOIN CARD c ON ca.CARD_NO = c.CARD_NO
    LEFT JOIN APPLICATION_USER_INFO au ON ca.APPLICATION_NO = au.APPLICATION_NO
    LEFT JOIN APPLICATION_SIGN asg ON ca.SIGN_NO = asg.SIGN_NO
    WHERE ca.APPLICATION_NO = #{applicationNo}
  </select>

  <!-- ✅ 신청번호로 동의한 약관 목록 조회 -->
  <select id="getAgreedTerms" parameterType="long" resultType="map">
    SELECT
      at.AGREEMENT_NO,
      pf.PDF_NAME,
      pf.TERM_SCOPE,
      pf.UPLOAD_DATE
    FROM APPLICATION_TERMS at
    JOIN PDF_FILES pf ON at.TERM_NO = pf.PDF_NO
    WHERE at.APPLICATION_NO = #{applicationNo}
  </select>

  <!-- ✅ 카드 번호로 약관 목록 + 파일명 조회 -->
  <select id="getCardPdfList" parameterType="long" resultType="map">
    SELECT
      cpm.CARD_NO,
      pf.PDF_NAME,
      pf.TERM_SCOPE,
      cpm.IS_REQUIRED
    FROM CARD_PDF_MAPPING cpm
    JOIN PDF_FILES pf ON cpm.PDF_NO = pf.PDF_NO
    WHERE cpm.CARD_NO = #{cardNo}
  </select>
  
  <select id="selectCardNoByApplication" parameterType="long" resultType="long">
    SELECT CARD_NO
    FROM CARD_APPLICATION
    WHERE APPLICATION_NO = #{applicationNo}
</select>

</mapper>
