<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busanbank.card.branch.mapper.BranchMapper">

  <resultMap id="BranchMap" type="com.busanbank.card.branch.dto.BranchDto">
    <id    property="branchNo"     column="BRANCH_NO"/>
    <result property="branchName"  column="BRANCH_NAME"/>
    <result property="branchAddress" column="BRANCH_ADDRESS"/>
    <result property="branchTel"   column="BRANCH_TEL"/>
    <result property="latitude"    column="LATITUDE"/>
    <result property="longitude"   column="LONGITUDE"/>
  </resultMap>

  <select id="selectAll" resultMap="BranchMap">
    SELECT BRANCH_NO, BRANCH_NAME, BRANCH_ADDRESS, BRANCH_TEL, LATITUDE, LONGITUDE
    FROM BNK_BRANCH
    ORDER BY BRANCH_NO
  </select>

  <select id="selectAllWithoutLatLng" resultMap="BranchMap">
    SELECT BRANCH_NO, BRANCH_NAME, BRANCH_ADDRESS, BRANCH_TEL, LATITUDE, LONGITUDE
    FROM BNK_BRANCH
    WHERE LATITUDE IS NULL OR LONGITUDE IS NULL
    ORDER BY BRANCH_NO
  </select>

  <update id="updateBranchLocation">
    UPDATE BNK_BRANCH
       SET LATITUDE  = #{latitude},
           LONGITUDE = #{longitude}
     WHERE BRANCH_NO = #{branchNo}
  </update>

	<select id="searchBranches" resultMap="BranchMap">
	    SELECT
	        BRANCH_NO,
	        BRANCH_NAME,
	        BRANCH_TEL,
	        BRANCH_ADDRESS,
	        LATITUDE,
	        LONGITUDE
	    FROM BNK_BRANCH
	    WHERE (BRANCH_NAME LIKE #{keyword}
	        OR BRANCH_ADDRESS LIKE #{keyword}
	        OR BRANCH_TEL LIKE #{keyword})
	      AND LATITUDE IS NOT NULL
	      AND LONGITUDE IS NOT NULL
	</select>
	
<!-- 검색 카운트 -->
  <select id="count" parameterType="map" resultType="long">
  <bind name="kw" value="(q != null &amp;&amp; q != '') ? '%' + q.toLowerCase() + '%' : null" />
  SELECT COUNT(*)
  FROM bnk_branch
  <where>
    <if test="kw != null">
      (LOWER(BRANCH_NAME) LIKE #{kw}
       OR LOWER(BRANCH_ADDRESS) LIKE #{kw})
    </if>
  </where>
</select>

<select id="selectPage" parameterType="map" resultMap="BranchMap">
  <bind name="kw" value="(q != null &amp;&amp; q != '') ? '%' + q.toLowerCase() + '%' : null" />
  SELECT *
  FROM bnk_branch
  <where>
    <if test="kw != null">
      (LOWER(BRANCH_NAME) LIKE #{kw}
       OR LOWER(BRANCH_ADDRESS) LIKE #{kw})
    </if>
  </where>
  ORDER BY BRANCH_NO DESC
  OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
</select>

 <!-- 단건 조회 -->
<select id="findById" parameterType="long" resultMap="BranchMap">
  SELECT * FROM bnk_branch WHERE BRANCH_NO = #{id}
</select>

 <!-- 등록 -->
<insert id="insert" parameterType="com.busanbank.card.branch.dto.BranchDto">
  INSERT INTO bnk_branch
    (BRANCH_NO, BRANCH_NAME, BRANCH_ADDRESS, BRANCH_TEL, LATITUDE, LONGITUDE)
  VALUES
    (SEQ_BRANCH_NO.NEXTVAL,
     #{branchName},
     #{branchAddress},
     #{branchTel},
     #{latitude,  jdbcType=NUMERIC},
     #{longitude, jdbcType=NUMERIC})
</insert>

  <!-- 삭제 -->
  <delete id="deleteById" parameterType="long">
    DELETE FROM bnk_branch WHERE BRANCH_NO = #{id}
  </delete>

</mapper>